<!DOCTYPE html>
<html lang="en">
    <head>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" integrity="sha512-8bHTC73gkZ7rZ7vpqUQThUDhqcNFyYi2xgDgPDHc+GXVGHXq+xPjynxIopALmOPqzo9JZj0k6OqqewdGO3EsrQ==" crossorigin="anonymous" />
        <title>Alone RPG</title>
    </head>
    <body onload="markFavourites()">
        <div class="ui container" style="padding-top: 20px">
            <div class="ui segment">
                <h1 class="ui header left aligned">Alone RPG:</h1>
                <div class="ui three column very relaxed grid">
                    <div class="column">
                        <form class="ui form" id="filter" action="/">
                            <div class="field">
                                <label>Search Table:</label>
                                <input type="text" placeholder="Filter" id="searchfield" name="searchfield" value="{{ current_filter }}">
                            </div>
                            <input type="submit" class="ui button" onclick="filterButtonSubmit()" value="Filter">
                            <input type="button" class="ui button" onclick="resetFilterSubmit()" value="Reset">
                            <div class="ui checkbox">
                                <input type="checkbox" onclick="toggleFavourites()" name="favourites_checkbox" id="favourites_checkbox" value="">
                                <label>Only favourites</label>
                            </div>
                        </form>
                    </div>
                    <div class="column ui form">
                        <div class="field">
                            <label>Roll:</label>
                            <input type="text" placeholder="1d6" id="roll-dice" name="roll-dice" value="{{ roll_dice_input }}">
                        </div>
                        <span>
                            <button class="ui button" onClick="rollDice();">Roll</button>
                            {{ roll_dice_response.data }}
                            {{ roll_dice_response.message }}
                        </span>
                    </div>
                    {% if roll_data %}
                    <div class="column">
                        <h3>{{ roll_message }}</h3>
                        <p>{{ roll_data }}</p>
                        <button class="ui button" onClick="window.location.reload();">Roll Again</button>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="ui segment">
                <h2>{{ filter_message }}</h2>
                <div class="ui grid">
                    {% for table in tables %}
                    {% if rolled_table == table.index %}
                    <div class="four wide column">
                        <input type="checkbox" id="favourite {{ table.index }}" onclick="manageFavourites('favourite {{ table.index }}')">
                        <a class="fluid primary small ui button" onclick="rollTableButton('?rtn={{ table.index }}&searchfield={{ current_filter }}')">({{ table.system }}) {{ table.filename }}</a>
                    </div>
                    {% else %}
                    <div class="four wide column">
                        <input type="checkbox" id="favourite {{ table.index }}" onclick="manageFavourites('favourite {{ table.index }}')">
                        <a class="fluid small ui button" onclick="rollTableButton('?rtn={{ table.index }}&searchfield={{ current_filter }}')">({{ table.system }}) {{ table.filename }}</a>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
        <script>
            function rollTableButton(partial_link){
                if (document.getElementById("favourites_checkbox").checked === true){
                    window.location = partial_link + "&favourites_checkbox=" + getFavourites();
                } else {
                    window.location = partial_link;
                }
            }

            function resetFilterSubmit() {
                document.getElementById("searchfield").value = "";
                document.getElementById("favourites_checkbox").value = getFavourites();
                document.getElementById("filter").submit();
            }

            function filterButtonSubmit(){
                document.getElementById("favourites_checkbox").value = getFavourites()
                document.getElementById("filter").submit();
            }

            function getFavourites(){
                if (document.getElementById("favourites_checkbox").checked === true){
                    return Array.from(loadFavourites());
                }
            }

            function toggleFavourites(){
                if (document.getElementById("favourites_checkbox").checked == true){
                    localStorage.only_favourites = true;
                } else {
                    localStorage.only_favourites = false;
                }
            }

            function addFavourite(favourite){
                var favourites = loadFavourites();

                favourites.add(favourite);
                localStorage.favourites = Array.from(favourites).join(",");
            }

            function removeFavourite(favourite){
                var favourites = loadFavourites();

                favourites.delete(favourite);
                localStorage.favourites = Array.from(favourites).join(",");
            }

            function manageFavourites(favourite){
                var checkBox = document.getElementById(favourite);

                if (checkBox.checked == true){
                    addFavourite(favourite.split(" ")[1]);
                } else {
                    removeFavourite(favourite.split(" ")[1]);
                }
            }

            function loadFavourites(){
                if (!localStorage.favourites){
                    return new Set();
                }
                return new Set(localStorage.favourites.split(","));
            }

            function markFavourites(){
                var favourites = loadFavourites();

                if (localStorage.only_favourites === "true"){
                    document.getElementById("favourites_checkbox").checked = true
                }

                for (let favourite of favourites){
                    var checkBox = document.getElementById("favourite " + favourite);
                    if (checkBox){
                    checkBox.checked = true;
                    }
                }
            }

            function rollDice() {
                let rollDiceValue = document.getElementById("roll-dice").value;
                const urlParams = new URLSearchParams(window.location.search);

                if (urlParams.has("roll-dice")) {
                    urlParams.set("roll-dice", rollDiceValue);
                } else {
                    urlParams.append("roll-dice", rollDiceValue)
                }
                var parameters = "?";
                urlParams.forEach(function(value, key) {
                    parameters += key + "=" + value + "&";
                });
                window.location = window.location.origin + parameters.slice(0, -1);
            }
        </script>
    </body>
</html>
